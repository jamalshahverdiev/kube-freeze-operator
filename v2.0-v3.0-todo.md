# TODO — kube-freeze-operator v2.0 and v3.0

> This document complements the v1.0 plan and defines the **exact scope of work** for v2.0 and v3.0.
> Format: tasks, subtasks, acceptance criteria, tests, documentation.
> Principle: clear specification first → implementation second.

---

## v2.0 — GitOps-friendly Pause/Resume + Noise Reduction

### Goal of v2.0
Make it so that during active freeze:
- GitOps (Argo CD / Flux) **doesn't try to sync indefinitely** and doesn't clutter the UI with errors,
- operator can **put GitOps into "pause"** and restore it back,
- while webhook enforcement from v1.0 remains the source of truth (and protection).

---

## 1) Scope & decisions (mandatory decisions before code)

- [ ] Choose Argo CD integration strategy
  - [ ] Option A: manage **ArgoCD Application CR** (recommended)
  - [ ] Option B: ArgoCD API calls (undesirable in v2.0)
- [ ] Choose Flux integration strategy
  - [ ] Manage **Kustomization** and/or **HelmRelease** resources via their suspend fields
- [ ] Define behavior model:
  - [ ] During freeze: put GitOps in pause (if enabled)
  - [ ] Outside freeze: restore GitOps (only if operator touched it)
- [ ] Define conflict policy:
  - [ ] If user manually changed paused/suspend → who "wins"?
  - [ ] Recommendation: **don't overwrite** manual changes; restore only what's managed by operator.
- [ ] Update v2.0 specification (docs/spec.md)
  - [ ] Define policy fields for GitOps behavior
  - [ ] Define policy priorities during GitOps pause

**Definition of Done**
- Decisions on ArgoCD/Flux approaches are made and documented in docs/spec.md

---

## 2) API changes (CRD extensions)

### 2.1 Add GitOps section to policies
- [ ] MaintenanceWindow.spec.behavior.gitops (new block)
  - [ ] `enabled: bool`
  - [ ] `providers: ["argocd","flux"]` (list)
  - [ ] `argocd`:
    - [ ] `applicationSelector` (label selector)
    - [ ] `namespaceSelector` (for namespace where Applications are located)
    - [ ] `pauseMode` (possible modes):
      - [ ] `DisableAutoSync` (if Application managed, disable automated)
      - [ ] `SetAppPausedAnnotation` (if using your annotation/plugin mechanism)
  - [ ] `flux`:
    - [ ] `kustomizationSelector` / `helmReleaseSelector`
    - [ ] `namespaceSelector`
- [ ] ChangeFreeze.spec.behavior.gitops (similarly)
- [ ] FreezeException — decide: should GitOps pause be allowed? (usually not)

### 2.2 Status improvements (visibility)
- [ ] MaintenanceWindow.status:
  - [ ] `gitopsPausedCount` (how many objects in pause)
  - [ ] `gitopsLastReconcileTime`
- [ ] ChangeFreeze.status:
  - [ ] similarly

### 2.3 Schema validations
- [ ] If `behavior.gitops.enabled=true`:
  - [ ] require valid selectors
  - [ ] restrict allowed provider values

**Definition of Done**
- CRD schemas are updated, sample YAMLs exist in `/config/samples/` and `/examples/`

---

## 3) Argo CD integration (controller)

### 3.1 Research and management model
- [ ] Define "pause" method for ArgoCD Application
  - [ ] Method 1 (recommended): patch `spec.syncPolicy.automated` (on/off)
  - [ ] Additionally: optionally set annotation `freeze-operator.io/argocd-paused="true"`
- [ ] Choose safe "restore" method
  - [ ] Store original state:
    - [ ] managed annotation `freeze-operator.io/managed="true"`
    - [ ] `freeze-operator.io/original-autosync="true|false"`
    - [ ] `freeze-operator.io/managed-by-policy="<policyRef>"`

### 3.2 Implement reconciler
- [ ] Watch ArgoCD Application CR (if CRD installed)
- [ ] For each target Application:
  - [ ] Calculate active freeze state (via policy engine)
  - [ ] If freeze active and gitops enabled:
    - [ ] If autosync enabled → disable + mark managed + save original
  - [ ] If freeze not active:
    - [ ] If managed by operator → restore original autosync value and remove managed annotations
- [ ] Add conflict protection:
  - [ ] if original not found → don't touch (fail-safe)
  - [ ] if policy changed → recalculate desired

### 3.3 RBAC
- [ ] Add RBAC for read/patch ArgoCD Application (usually group `argoproj.io`)
- [ ] Make this optional via helm values (if argo missing — don't require permissions)

### 3.4 Compatibility
- [ ] Presence/absence of ArgoCD CRD:
  - [ ] if CRD missing, controller doesn't start / disables gracefully

**Definition of Done**
- In production scenario ArgoCD stops spamming sync errors during freeze, everything restores after

---

## 4) Flux integration (controller)

### 4.1 Choose resources (minimum)
- [ ] Flux Kustomization (kustomize.toolkit.fluxcd.io)
- [ ] Flux HelmRelease (helm.toolkit.fluxcd.io)

### 4.2 Implement pause/resume
- [ ] For Kustomization:
  - [ ] manage `spec.suspend`
- [ ] For HelmRelease:
  - [ ] manage `spec.suspend`
- [ ] Managed annotations:
  - [ ] `freeze-operator.io/managed="true"`
  - [ ] `freeze-operator.io/original-suspend="true|false"`
  - [ ] `freeze-operator.io/managed-by-policy="<policyRef>"`

### 4.3 RBAC
- [ ] RBAC for patch Kustomization/HelmRelease
- [ ] Optional enabling via values

### 4.4 Missing CRD
- [ ] graceful disable if CRD not installed

**Definition of Done**
- Flux stops applying changes during freeze and correctly resumes after

---

## 5) Webhook noise reduction (UX improvements)

- [ ] Improve deny message for GitOps:
  - [ ] recognize user-agent / serviceaccount Argo/Flux
  - [ ] provide short clear message (without extra text)
- [ ] Add rate limiting / sampling for Events (to avoid flooding cluster events)
- [ ] Add correlation fields in logs:
  - [ ] request UID
  - [ ] policyRef
  - [ ] gitops provider detected

**Definition of Done**
- During active freeze, GitOps UI is cleaner, not too many events, messages are clear

---

## 6) Testing (v2.0)

### Unit tests
- [ ] Policy engine: gitops behavior flags don't break basic logic
- [ ] Managed restore logic for Argo/Flux (table test cases)

### Integration tests (envtest / kind)
- [ ] With ArgoCD CRDs installed:
  - [ ] autosync toggled on freeze, restored after
- [ ] With Flux CRDs installed:
  - [ ] suspend toggled on freeze, restored after
- [ ] Webhook still denies direct workload changes

**Definition of Done**
- CI runs tests; e2e scenarios confirm pause/resume

---

## 7) Documentation (v2.0)

- [ ] docs/gitops-argocd.md
  - [ ] how to enable in values
  - [ ] how to target apps selectors
  - [ ] what restore looks like
- [ ] docs/gitops-flux.md
- [ ] docs/upgrade-v1.0-to-v2.0.md
- [ ] examples:
  - [ ] prod window + argocd pause
  - [ ] changefreeze + flux pause

**Release checklist v2.0**
- [ ] v2.0.0 tag + release notes
- [ ] chart updated (GitOps options, RBAC optional)
- [ ] backward compatible with v1.0 policies

---

---

# v3.0 — CI Helper API + Ready-to-use CI Templates

### Goal of v3.0
Provide an easy way to integrate freeze into CI/CD:
- REST API: "can I deploy now?"
- standardized templates for GitLab CI / GitHub Actions
- unified response format (to easily abort job with explanation)
- (optional) CLI utility `kfo` for local checking.

---

## 1) Scope & design decisions (before code)

- [ ] Choose interface:
  - [ ] HTTP REST endpoint (inside cluster) + optional Ingress
- [ ] Choose authentication:
  - [ ] v3.0 MVP: Kubernetes ServiceAccount token (in-cluster) + RBAC "can-i"
  - [ ] Out-of-cluster: kubeconfig/port-forward (doc)
- [ ] Define endpoint contract:
  - [ ] `GET /v1/can-i-deploy?...`
  - [ ] or `POST /v1/evaluate` (better for complex payload)
- [ ] Define request fields:
  - [ ] namespace
  - [ ] kind
  - [ ] name (optional)
  - [ ] labels (optional override?)
  - [ ] action (ROLL_OUT/SCALE/CREATE/DELETE)
  - [ ] user/groups (if need to simulate)
- [ ] Define response fields:
  - [ ] allow (bool)
  - [ ] reason (string)
  - [ ] matchedPolicy (ref)
  - [ ] nextAllowedTime / freezeEndTime
  - [ ] docsURL/contact
  - [ ] suggestedException (optional hint)
- [ ] Define API stability:
  - [ ] v3.0: `v1` endpoint but `alpha` schema is allowed, describe in docs

**Definition of Done**
- API contract described in docs/api.md + request/response examples

---

## 2) API Server component

- [ ] Add HTTP server to manager (or separate sidecar/container)
  - [ ] Preferred path: in manager (simpler deployment)
- [ ] Implement handler:
  - [ ] normalize kind/action
  - [ ] get namespace/object labels (if name specified)
  - [ ] call policy engine with given parameters
- [ ] Logging and metrics:
  - [ ] `freeze_api_requests_total{decision}`
  - [ ] latency histogram (optional)
- [ ] RBAC:
  - [ ] if API can fetch object by name → need get permissions on resources
  - [ ] minimize permissions, make mode optional:
    - [ ] mode A: client provides labels itself (then operator doesn't read object)
    - [ ] mode B: operator reads object by name (more convenient, but more permissions)
- [ ] Security:
  - [ ] enable/disable API via helm values
  - [ ] restrict access with NetworkPolicy (docs recommendations)

**Definition of Done**
- API responds correctly and predictably, doesn't require excessive permissions in mode A

---

## 3) CI templates (ready to copy-paste)

### 3.1 GitLab CI template
- [ ] Create `/ci/gitlab/freeze-check.yml`
  - [ ] job/stage `freeze-check`
  - [ ] variables:
    - [ ] FREEZE_API_URL (cluster-internal or via port-forward)
    - [ ] TARGET_NAMESPACE, TARGET_KIND, ACTION
  - [ ] script:
    - [ ] curl → parse json → if deny → fail job with reason
- [ ] Add docs:
  - [ ] how to include in `.gitlab-ci.yml`
  - [ ] how to pass serviceaccount token/cluster access
  - [ ] examples for helm deploy / kubectl apply

### 3.2 GitHub Actions (optional but nice)
- [ ] Workflow snippet
- [ ] example using kubectl port-forward + curl

**Definition of Done**
- User can connect template in 5–10 minutes and get deployment blocking in CI

---

## 4) Optional: CLI `kfo` (if time permits in v3.0)

- [ ] Command `kfo can-i`:
  - [ ] parameters: namespace/kind/name/action
  - [ ] modes:
    - [ ] API call
    - [ ] direct kube API (if kubeconfig)
- [ ] Output:
  - [ ] human-friendly + `--json` for automation

**Definition of Done**
- CLI works as convenient helper, but not mandatory for v3.0 release

---

## 5) Testing (v3.0)

- [ ] Unit tests:
  - [ ] API contract (validators, required fields)
  - [ ] policy evaluation via API
- [ ] Integration tests:
  - [ ] start operator + API
  - [ ] apply policy, check can-i endpoint deny/allow
- [ ] CI template smoke test (doc-level):
  - [ ] example pipeline with deny/allow (can be doc + manual test)

**Definition of Done**
- API and templates are covered by tests, main cases don't break with changes

---

## 6) Documentation (v3.0)

- [ ] docs/api.md
  - [ ] endpoints, request/response examples
  - [ ] security model
- [ ] docs/ci/gitlab.md
- [ ] docs/ci/github.md (optional)
- [ ] docs/upgrade-v2.0-to-v3.0.md
- [ ] examples:
  - [ ] policy + GitLab pipeline sample

**Release checklist v3.0**
- [ ] v3.0.0 tag + release notes
- [ ] Helm chart: enable api server + RBAC modes
- [ ] CI templates included and documented
- [ ] Backward compatible with v1.0/v2.0

---

## Roadmap Notes (after v3.0)
- v4.0: Multi-cluster policies + global freeze propagation
- v5.0: FreezeEvent CRD + external audit sinks (Webhook → ELK/OTel)
- v6.0: Advanced rule matching (field selectors/diff constraints)
