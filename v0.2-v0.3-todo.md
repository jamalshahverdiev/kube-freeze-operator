# TODO — kube-freeze-operator v0.2 and v0.3

> Этот документ дополняет план v0.1 и фиксирует **точный объём работ** для v0.2 и v0.3.
> Формат: задачи, подзадачи, критерии готовности, тесты, документация.
> Принцип: сначала чёткая спецификация → потом реализация.

---

## v0.2 — GitOps-friendly Pause/Resume + Noise Reduction

### Цель v0.2
Сделать так, чтобы при активном freeze:
- GitOps (Argo CD / Flux) **не пытался бесконечно синкаться** и не засорял UI ошибками,
- оператор мог **ставить GitOps в "pause"** и возвращать обратно,
- при этом webhook enforcement из v0.1 остаётся источником истины (и защитой).

---

## 1) Scope & decisions (обязательные решения до кода)

- [ ] Выбрать стратегию интеграции с Argo CD
  - [ ] Вариант A: управление **ArgoCD Application CR** (рекомендовано)
  - [ ] Вариант B: вызовы ArgoCD API (нежелательно в v0.2)
- [ ] Выбрать стратегию интеграции с Flux
  - [ ] Управление ресурсами **Kustomization** и/или **HelmRelease** через их поля suspend
- [ ] Зафиксировать модель поведения:
  - [ ] В freeze: поставить GitOps в pause (если включено)
  - [ ] Вне freeze: вернуть GitOps назад (только если оператор его трогал)
- [ ] Зафиксировать политику при конфликте:
  - [ ] Если пользователь вручную изменил paused/suspend → кто "побеждает"?
  - [ ] Рекомендация: **не перетирать** ручные изменения; возвращать только то, что managed оператором.
- [ ] Обновить спецификацию v0.2 (docs/spec.md)
  - [ ] Определить поля policy для GitOps поведения
  - [ ] Определить приоритеты политик при GitOps pause

**Definition of Done**
- Приняты решения по ArgoCD/Flux подходам и зафиксированы в docs/spec.md

---

## 2) API changes (CRD расширения)

### 2.1 Добавить GitOps section в policies
- [ ] MaintenanceWindow.spec.behavior.gitops (новый блок)
  - [ ] `enabled: bool`
  - [ ] `providers: ["argocd","flux"]` (список)
  - [ ] `argocd`:
    - [ ] `applicationSelector` (label selector)
    - [ ] `namespaceSelector` (на namespace, где стоят Applications)
    - [ ] `pauseMode` (возможные режимы):
      - [ ] `DisableAutoSync` (если Application managed, выключить automated)
      - [ ] `SetAppPausedAnnotation` (если используется ваш механизм аннотации/плагина)
  - [ ] `flux`:
    - [ ] `kustomizationSelector` / `helmReleaseSelector`
    - [ ] `namespaceSelector`
- [ ] ChangeFreeze.spec.behavior.gitops (аналогично)
- [ ] FreezeException — решить: нужно ли разрешать GitOps pause? (обычно нет)

### 2.2 Status improvements (наглядность)
- [ ] MaintenanceWindow.status:
  - [ ] `gitopsPausedCount` (сколько объектов в pause)
  - [ ] `gitopsLastReconcileTime`
- [ ] ChangeFreeze.status:
  - [ ] аналогично

### 2.3 Валидации схемы
- [ ] Если `behavior.gitops.enabled=true`:
  - [ ] требовать корректные selectors
  - [ ] ограничить допустимые provider values

**Definition of Done**
- CRD schema обновлены, есть samples YAML в `/config/samples/` и `/examples/`

---

## 3) Argo CD integration (controller)

### 3.1 Исследование и модель управления
- [ ] Определить способ "pause" ArgoCD Application
  - [ ] Способ 1 (рекомендовано): патчить `spec.syncPolicy.automated` (вкл/выкл)
  - [ ] Дополнительно: опционально ставить аннотацию `freeze-operator.io/argocd-paused="true"`
- [ ] Выбрать безопасный способ "restore"
  - [ ] Сохранять original state:
    - [ ] managed annotation `freeze-operator.io/managed="true"`
    - [ ] `freeze-operator.io/original-autosync="true|false"`
    - [ ] `freeze-operator.io/managed-by-policy="<policyRef>"`

### 3.2 Реализация reconciler
- [ ] Watch ArgoCD Application CR (если установлен CRD)
- [ ] Для каждого target Application:
  - [ ] Вычислить active freeze state (через policy engine)
  - [ ] Если freeze активен и gitops enabled:
    - [ ] Если autosync включен → выключить + пометить managed + сохранить original
  - [ ] Если freeze не активен:
    - [ ] Если managed operator → восстановить оригинальное значение autosync и снять managed annotations
- [ ] Добавить защиту от конфликтов:
  - [ ] если original не найден → не трогать (fail-safe)
  - [ ] если policy изменилась → пересчитать desired

### 3.3 RBAC
- [ ] Добавить RBAC на чтение/патч ArgoCD Application (обычно group `argoproj.io`)
- [ ] Сделать это опционально через helm values (если арго нет — не требовать прав)

### 3.4 Совместимость
- [ ] Наличие/отсутствие CRD ArgoCD:
  - [ ] при отсутствии CRD контроллер не стартует / отключается gracefully

**Definition of Done**
- В продовом сценарии ArgoCD перестаёт спамить sync-ошибками во freeze, после окончания всё возвращается

---

## 4) Flux integration (controller)

### 4.1 Выбор ресурсов (минимум)
- [ ] Flux Kustomization (kustomize.toolkit.fluxcd.io)
- [ ] Flux HelmRelease (helm.toolkit.fluxcd.io)

### 4.2 Реализация pause/resume
- [ ] Для Kustomization:
  - [ ] управлять `spec.suspend`
- [ ] Для HelmRelease:
  - [ ] управлять `spec.suspend`
- [ ] Managed annotations:
  - [ ] `freeze-operator.io/managed="true"`
  - [ ] `freeze-operator.io/original-suspend="true|false"`
  - [ ] `freeze-operator.io/managed-by-policy="<policyRef>"`

### 4.3 RBAC
- [ ] RBAC на patch Kustomization/HelmRelease
- [ ] Опциональное включение через values

### 4.4 Отсутствие CRD
- [ ] graceful disable если CRD не установлен

**Definition of Done**
- Flux перестаёт применять изменения во freeze и корректно возобновляет после

---

## 5) Webhook noise reduction (UX improvements)

- [ ] Улучшить deny message для GitOps:
  - [ ] распознавать user-agent / serviceaccount Argo/Flux
  - [ ] выдавать короткое понятное сообщение (без лишнего текста)
- [ ] Добавить rate limiting / sampling для Events (чтобы не завалить cluster events)
- [ ] Добавить correlation fields в логах:
  - [ ] request UID
  - [ ] policyRef
  - [ ] gitops provider detected

**Definition of Done**
- При активном freeze UI GitOps аккуратнее, событий не слишком много, сообщения понятные

---

## 6) Testing (v0.2)

### Unit tests
- [ ] Policy engine: gitops behavior flags не ломают базовую логику
- [ ] Managed restore logic для Argo/Flux (табличные кейсы)

### Integration tests (envtest / kind)
- [ ] With ArgoCD CRDs installed:
  - [ ] autosync toggled on freeze, restored after
- [ ] With Flux CRDs installed:
  - [ ] suspend toggled on freeze, restored after
- [ ] Webhook still denies прямые изменения workloads

**Definition of Done**
- CI прогоняет тесты; e2e сценарии подтверждают pause/resume

---

## 7) Documentation (v0.2)

- [ ] docs/gitops-argocd.md
  - [ ] как включить в values
  - [ ] как таргетить apps selectors
  - [ ] как выглядит restore
- [ ] docs/gitops-flux.md
- [ ] docs/upgrade-v0.1-to-v0.2.md
- [ ] examples:
  - [ ] prod window + argocd pause
  - [ ] changefreeze + flux pause

**Release checklist v0.2**
- [ ] v0.2.0 tag + release notes
- [ ] chart обновлён (опции GitOps, RBAC optional)
- [ ] backward compatible policies v0.1

---

---

# v0.3 — CI Helper API + Ready-to-use CI Templates

### Цель v0.3
Дать лёгкий способ интегрировать freeze в CI/CD:
- REST API: “можно ли деплоить сейчас?”
- стандартизированные templates для GitLab CI / GitHub Actions
- единый формат ответа (чтобы легко прерывать job с объяснением)
- (опционально) CLI утилита `kfo` для локальной проверки.

---

## 1) Scope & design decisions (до кода)

- [ ] Выбрать интерфейс:
  - [ ] HTTP REST endpoint (внутри кластера) + опциональный Ingress
- [ ] Выбрать аутентификацию:
  - [ ] v0.3 MVP: Kubernetes ServiceAccount token (in-cluster) + RBAC "can-i"
  - [ ] Out-of-cluster: kubeconfig/port-forward (doc)
- [ ] Определить endpoint contract:
  - [ ] `GET /v1/can-i-deploy?...`
  - [ ] или `POST /v1/evaluate` (лучше для сложных payload)
- [ ] Определить поля запроса:
  - [ ] namespace
  - [ ] kind
  - [ ] name (optional)
  - [ ] labels (optional override?)
  - [ ] action (ROLL_OUT/SCALE/CREATE/DELETE)
  - [ ] user/groups (если нужно имитировать)
- [ ] Определить поля ответа:
  - [ ] allow (bool)
  - [ ] reason (string)
  - [ ] matchedPolicy (ref)
  - [ ] nextAllowedTime / freezeEndTime
  - [ ] docsURL/contact
  - [ ] suggestedException (optional hint)
- [ ] Определить стабильность API:
  - [ ] v0.3: `v1` endpoint но `alpha` schema допускается, описать в docs

**Definition of Done**
- API contract описан в docs/api.md + примеры запрос/ответ

---

## 2) API Server component

- [ ] Добавить HTTP server в manager (или отдельный sidecar/контейнер)
  - [ ] Путь предпочтителен: в manager (проще деплой)
- [ ] Реализовать handler:
  - [ ] нормализация kind/action
  - [ ] получение namespace/object labels (если name указан)
  - [ ] вызвать policy engine с заданными параметрами
- [ ] Логирование и метрики:
  - [ ] `freeze_api_requests_total{decision}`
  - [ ] latency histogram (опционально)
- [ ] RBAC:
  - [ ] если API умеет подгружать объект по name → нужны права get на ресурсы
  - [ ] минимизировать права, сделать опционально режим:
    - [ ] режим A: клиент передаёт labels сам (тогда operator не читает объект)
    - [ ] режим B: operator читает объект по name (удобнее, но больше прав)
- [ ] Безопасность:
  - [ ] включить/выключить API через helm values
  - [ ] ограничить доступ NetworkPolicy (docs рекомендации)

**Definition of Done**
- API отвечает корректно и предсказуемо, не требует лишних прав в режиме A

---

## 3) CI templates (готовые к копипасте)

### 3.1 GitLab CI template
- [ ] Создать `/ci/gitlab/freeze-check.yml`
  - [ ] job/stage `freeze-check`
  - [ ] переменные:
    - [ ] FREEZE_API_URL (cluster-internal или через port-forward)
    - [ ] TARGET_NAMESPACE, TARGET_KIND, ACTION
  - [ ] скрипт:
    - [ ] curl → parse json → если deny → fail job с reason
- [ ] Добавить docs:
  - [ ] как подключить `include:` в `.gitlab-ci.yml`
  - [ ] как прокинуть serviceaccount token/cluster access
  - [ ] примеры для helm deploy / kubectl apply

### 3.2 GitHub Actions (optional but nice)
- [ ] Workflow snippet
- [ ] пример использования kubectl port-forward + curl

**Definition of Done**
- Пользователь может за 5–10 минут подключить шаблон и получать блокировку деплоев в CI

---

## 4) Optional: CLI `kfo` (если успеется в v0.3)

- [ ] Команда `kfo can-i`:
  - [ ] параметры: namespace/kind/name/action
  - [ ] режимы:
    - [ ] вызов API
    - [ ] прямой kube API (если kubeconfig)
- [ ] Output:
  - [ ] human-friendly + `--json` для автоматизации

**Definition of Done**
- CLI работает как удобный helper, но не обязателен для релиза v0.3

---

## 5) Testing (v0.3)

- [ ] Unit tests:
  - [ ] API contract (валидаторы, обязательные поля)
  - [ ] policy evaluation via API
- [ ] Integration tests:
  - [ ] поднять operator + API
  - [ ] применить policy, проверить can-i endpoint deny/allow
- [ ] CI template smoke test (док-уровень):
  - [ ] пример pipeline с deny/allow (можно как doc + manual test)

**Definition of Done**
- API и шаблоны покрыты тестами, основные кейсы не ломаются при изменениях

---

## 6) Documentation (v0.3)

- [ ] docs/api.md
  - [ ] endpoints, request/response examples
  - [ ] security model
- [ ] docs/ci/gitlab.md
- [ ] docs/ci/github.md (optional)
- [ ] docs/upgrade-v0.2-to-v0.3.md
- [ ] examples:
  - [ ] policy + GitLab pipeline sample

**Release checklist v0.3**
- [ ] v0.3.0 tag + release notes
- [ ] Helm chart: enable api server + RBAC modes
- [ ] CI templates included and documented
- [ ] Backward compatible с v0.1/v0.2

---

## Roadmap Notes (после v0.3)
- v0.4: Multi-cluster policies + global freeze propagation
- v0.5: FreezeEvent CRD + внешние audit sinks (Webhook → ELK/OTel)
- v0.6: Advanced rule matching (field selectors/diff constraints)
